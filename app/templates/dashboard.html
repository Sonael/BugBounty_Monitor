{% extends "base.html" %}

{% block content %}

<div class="d-flex justify-content-between align-items-center dashboard-header-container">
    <div class="d-flex align-items-center">
        <div class="header-icon-box me-3">
            <i class="fas fa-chart-pie"></i>
        </div>
        <div>
            <h1 class="dashboard-title">Dashboard</h1>
            <p class="dashboard-subtitle mb-0">Visão estratégica de superfície de ataque.</p>
        </div>
    </div>

    <div class="d-flex align-items-center gap-3">

        <div class="d-none d-md-flex align-items-center">
            <div class="header-meta-badge text-muted">
                <i class="fas fa-server text-success"></i>
                <span>Sistema Online</span>
            </div>
        </div>

        <div class="bg-white px-3 py-2 rounded shadow-sm d-flex align-items-center border"
            title="Tempo restante para o scan diário automático (00:00)">
            <div class="bg-primary bg-opacity-10 p-2 rounded-circle me-3 text-primary">
                <i class="fas fa-hourglass-half animate-pulse"></i>
            </div>
            <div class="lh-1">
                <span class="d-block text-muted fw-bold text-uppercase mb-1"
                    style="font-size: 0.65rem; letter-spacing: 0.5px;">
                    Próximo Scan Global
                </span>
                <span id="scan-timer" class="fw-bold font-monospace text-dark fs-5">--:--:--</span>
            </div>
        </div>

        {% if stats.running > 0 %}
        <form action="{{ url_for('main.stop_global_scan') }}" method="POST" class="d-inline">
            <button type="submit" class="btn btn-danger shadow-sm fw-bold px-3 py-2"
                onclick="return confirm('Isso vai interromper todos os scans ativos. Continuar?');">
                <i class="fas fa-stop-circle me-2"></i>Parar Scan Global
            </button>
        </form>
        {% else %}
        <form action="{{ url_for('main.start_global_scan') }}" method="POST" class="d-inline">
            <button type="submit" class="btn btn-success shadow-sm fw-bold px-3 py-2">
                <i class="fas fa-play-circle me-2"></i>Iniciar Scan Global
            </button>
        </form>
        {% endif %}

        <button class="btn btn-primary shadow-sm fw-bold px-4 py-2" data-bs-toggle="modal"
            data-bs-target="#newProjectModal">
            <i class="fas fa-plus-circle me-2"></i>Novo Alvo
        </button>
    </div>
</div>

<div hx-get="{{ url_for('main.htmx_stats') }}" 
     hx-trigger="load, every 3s" 
     hx-swap="innerHTML">
     
    {% include 'partials/dashboard_status.html' %}
</div>
<ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-pane"
            type="button" role="tab">
            <i class="fas fa-chart-line me-2"></i>Visão Geral & Insights
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="projects-tab" data-bs-toggle="tab" data-bs-target="#projects-pane" type="button"
            role="tab">
            <i class="fas fa-list-alt me-2"></i>Meus Projetos
        </button>
    </li>
</ul>

<div class="tab-content" id="dashboardTabsContent">

    <div class="tab-pane fade show active" id="overview-pane" role="tabpanel">
        <div class="row">
            <div class="col-lg-6 mb-3 mb-lg-0">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3 px-3">
                        <h6 class="fw-bold text-primary mb-0" style="font-size: 1.2rem;"><i
                                class="fas fa-shield-alt me-2"></i>Status de Segurança</h6>
                    </div>
                    <div class="card-body p-3">
                        {% if stats.vulns > 0 %}
                        <div class="d-flex justify-content-between mb-1">
                            <span class="fw-bold text-danger" style="font-size: 0.9rem;">CRÍTICO</span>
                            <span class="fw-bold text-dark" style="font-size: 0.9rem;">{{ severity.critical }}</span>
                        </div>
                        <div class="progress mb-2" style="height: 5px;">
                            <div class="progress-bar bg-danger" style="width: {{ severity.pct_critical }}%"></div>
                        </div>

                        <div class="d-flex justify-content-between mb-1">
                            <span class="fw-bold text-warning"
                                style="font-size: 0.9rem; color: #fd7e14 !important;">ALTO</span>
                            <span class="fw-bold text-dark" style="font-size: 0.9rem;">{{ severity.high }}</span>
                        </div>
                        <div class="progress mb-2" style="height: 5px;">
                            <div class="progress-bar bg-warning"
                                style="width: {{ severity.pct_high }}%; background-color: #fd7e14 !important;"></div>
                        </div>

                        <div class="d-flex justify-content-between mb-1">
                            <span class="fw-bold text-warning" style="font-size: 0.9rem;">MÉDIO</span>
                            <span class="fw-bold text-dark" style="font-size: 0.9rem;">{{ severity.medium }}</span>
                        </div>
                        <div class="progress mb-2" style="height: 5px;">
                            <div class="progress-bar bg-warning" style="width: {{ severity.pct_medium }}%"></div>
                        </div>

                        <div class="d-flex justify-content-between mb-1">
                            <span class="fw-bold text-info" style="font-size: 0.9rem;">BAIXO / INFO</span>
                            <span class="fw-bold text-dark" style="font-size: 0.9rem;">{{ severity.low + severity.info
                                }}</span>
                        </div>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar bg-info" style="width: {{ severity.pct_low }}%"></div>
                        </div>
                        {% else %}
                        <div class="text-center py-5 text-muted opacity-50">
                            <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                            <p class="mb-0 small">Sem vulnerabilidades.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div
                        class="card-header bg-white border-0 py-3 px-3 d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-bold text-primary mb-0" style="font-size: 1.2rem;"><i
                                    class="fas fa-history me-2"></i>Atividade Recente</h6>
                        </div>
                        <span class="badge bg-light text-primary border animate-pulse"
                            style="font-size: 0.6rem;">LIVE</span>
                    </div>
                    <div class="card-body p-0">
                        {% if recent_activity %}
                        <div class="list-group list-group-flush">
                            {% for domain in recent_activity %}
                            <div
                                class="list-group-item border-0 px-3 py-2 d-flex align-items-center {% if not loop.last %}border-bottom{% endif %}">
                                <div class="me-2">
                                    <div class="bg-light text-primary rounded-circle d-flex align-items-center justify-content-center"
                                        style="width: 32px; height: 32px; font-size: 1.3rem;">
                                        <i class="fas fa-globe"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 overflow-hidden">
                                    <h6 class="mb-0 fw-bold text-dark text-truncate" style="font-size: 0.9rem;">
                                        {{ domain.name }}
                                    </h6>
                                    <small class="text-muted d-block text-truncate" style="font-size: 0.8rem;">
                                        {{ domain.project.name }}
                                    </small>
                                </div>
                                <div class="text-end ms-2">
                                    <small class="text-muted fw-bold d-block" style="font-size: 0.8rem;">
                                        {{ domain.first_seen.strftime('%H:%M') }}
                                    </small>
                                    <span class="badge bg-light text-muted border mt-0"
                                        style="font-size: 0.7rem; padding: 0.25em 0.4em;">
                                        {{ domain.status_code or '-' }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5 text-muted opacity-50">
                            <i class="fas fa-ghost fa-2x mb-2 mt-2"></i>
                            <p class="mb-0 small">Sem atividades.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="projects-pane" role="tabpanel">
        <div class="row">
            {% for project in projects %}
            {% include 'partials/dashboard_card.html' %}

            <div class="modal fade" id="editModal{{ project.id }}" tabindex="-1" onclick="event.stopPropagation()">
                <div class="modal-dialog modal-lg">
                    <form method="POST" action="{{ url_for('main.edit_project', id=project.id) }}">
                        <div class="modal-content border-0 shadow-lg text-start">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title fw-bold"><i class="fas fa-edit me-2"></i>Editar Projeto</h5>
                                <button type="button" class="btn-close btn-close-white"
                                    data-bs-dismiss="modal"></button>
                            </div>

                            <div class="modal-body p-4">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Nome do Projeto</label>
                                        <input type="text" name="name" class="form-control" value="{{ project.name }}"
                                            required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Domínio Principal (Escopo)</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light"><i class="fas fa-globe"></i></span>
                                            <input type="text" name="target_url" class="form-control"
                                                value="{{ project.target_url }}" required>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4 text-muted">

                                <div class="mb-3 p-3 bg-light rounded border">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="auto_discovery" {% if
                                            project.discovery_enabled %}checked{% endif %}>
                                        <label class="form-check-label fw-bold">Habilitar Descoberta Automática</label>
                                    </div>
                                </div>

                                <div class="mb-3 p-3 bg-light rounded border">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="enable_fuzzing" {% if
                                            project.fuzzing_enabled %}checked{% endif %}>
                                        <label class="form-check-label fw-bold">Habilitar Fuzzing (FFuf)</label>
                                    </div>
                                </div>

                                <div class="mb-4 p-3 bg-light rounded border">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="enable_vuln_scan" {% if
                                            project.vuln_scan_enabled %}checked{% endif %}>
                                        <label class="form-check-label fw-bold text-danger">Habilitar Scan de Vuln no
                                            Baseline</label>
                                    </div>
                                    <div class="form-text small mt-2">
                                        <i class="fas fa-radiation me-1"></i>
                                        Se marcado, o sistema rodará <strong>Nuclei, XSS e SQLMap</strong> em todos os
                                        domínios encontrados.
                                        <span class="text-danger d-block mt-1">
                                            <i class="fas fa-exclamation-circle me-1"></i> <strong>Atenção:</strong>
                                            Isso tornará o scan inicial extremamente demorado.
                                        </span>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold text-success">
                                            <i class="fas fa-plus-circle me-1"></i> Adicionar ao Escopo (Manual)
                                        </label>
                                        <textarea name="in_scope" class="form-control font-monospace small" rows="5"
                                            placeholder="Digite novos domínios aqui...">{{ project.in_scope or '' }}</textarea>
                                        <div class="form-text">Domínios digitados aqui serão
                                            <strong>escaneados</strong>. <br> Não usar Wildcards(*).</div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold text-danger">
                                            <i class="fas fa-ban me-1"></i> Out of Scope (Ignorar)
                                        </label>
                                        <textarea name="out_of_scope" class="form-control font-monospace small"
                                            rows="5">{{ project.out_of_scope or '' }}</textarea>
                                        <div class="form-text">Estes domínios serão <strong>ignorados</strong> pelo
                                            scanner. <br> Pode usar Wildcards(*).</div>
                                    </div>
                                </div>
                            </div>

                            <div class="modal-footer bg-light">
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary fw-bold px-4">Salvar Alterações</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="modal fade" id="deleteModal{{ project.id }}" tabindex="-1" onclick="event.stopPropagation()">
                <div class="modal-dialog">
                    <div class="modal-content border-0 shadow-lg text-start">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Zona de
                                Perigo</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-4">
                            <p class="mb-3">Você está prestes a excluir o projeto <strong>{{ project.name }}</strong>
                                permanentemente.</p>
                            <div class="alert alert-danger bg-danger bg-opacity-10 border-danger text-danger">
                                <ul class="mb-0 small">
                                    <li>Todos os subdomínios serão perdidos.</li>
                                    <li>O histórico de vulnerabilidades será apagado.</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer bg-light">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <form action="{{ url_for('main.delete_project', id=project.id) }}" method="POST">
                                <button type="submit" class="btn btn-danger fw-bold">Sim, Apagar Tudo</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            {% else %}
            <div class="col-12 text-center py-5">
                <div class="text-muted opacity-25">
                    <i class="fas fa-folder-open fa-4x mb-3"></i>
                    <h3>Nenhum projeto encontrado.</h3>
                    <p>Clique em "Novo Alvo" para começar seu monitoramento.</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="modal fade" id="newProjectModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <form method="POST" action="{{ url_for('main.add_project') }}">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title fw-bold"><i class="fas fa-plus-circle me-2"></i>Adicionar Novo Alvo</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body p-4">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Nome do Projeto</label>
                                <input type="text" name="name" class="form-control"
                                    placeholder="Ex: Programa BugBounty X" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Domínio Principal (Escopo)</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="fas fa-globe"></i></span>
                                    <input type="text" name="target_url" class="form-control" placeholder="Ex: alvo.com"
                                        required>
                                </div>
                                <div class="form-text text-muted">Não inclua http:// ou https://</div>
                            </div>
                        </div>

                        <hr class="my-4 text-muted">

                        <div class="mb-3 p-3 bg-light rounded border">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoDiscoverySwitch"
                                    name="auto_discovery" checked>
                                <label class="form-check-label fw-bold" for="autoDiscoverySwitch">
                                    Habilitar Descoberta Automática
                                </label>
                            </div>

                            <div class="form-text small mt-2">
                                <span id="discoveryTextOn" class="text-success">
                                    <i class="fas fa-magic me-1"></i> O sistema irá rodar <strong>Subfinder e
                                        Amass</strong>
                                    para encontrar novos subdomínios.
                                </span>
                                <span id="discoveryTextOff" class="text-secondary d-none">
                                    <i class="fas fa-hand-paper me-1"></i> O sistema usará <strong>apenas</strong> os
                                    domínios listados em "In Scope".
                                </span>
                            </div>
                        </div>

                        <div class="mb-4 p-3 bg-light rounded border">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="fuzzingSwitch"
                                    name="enable_fuzzing">
                                <label class="form-check-label fw-bold" for="fuzzingSwitch">
                                    Habilitar Fuzzing no Baseline (FFuf)
                                </label>
                            </div>
                            <div class="form-text small mt-2">
                                <i class="fas fa-search-plus me-1"></i>
                                Se marcado, o sistema irá buscar diretórios ocultos (ex: /.git, /admin) logo na criação
                                do
                                projeto.
                                <span class="text-warning d-block mt-1">
                                    <i class="fas fa-clock me-1"></i> Isso tornará a criação do projeto mais lenta.
                                </span>
                            </div>
                        </div>

                        <div class="mb-4 p-3 bg-light rounded border">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="vulnSwitch" name="enable_vuln_scan">
                                <label class="form-check-label fw-bold" for="vulnSwitch">
                                    Habilitar Scan de Vuln no Baseline
                                </label>
                            </div>
                            <div class="form-text small mt-2">
                                <i class="fas fa-radiation me-1"></i>
                                Se marcado, o sistema rodará <strong>Nuclei, XSS e SQLMap</strong> em todos os domínios
                                encontrados agora.
                                <span class="text-danger d-block mt-1">
                                    <i class="fas fa-exclamation-circle me-1"></i> Isso tornará o scan inicial
                                    extremamente longo.
                                </span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-success">
                                    <i class="fas fa-plus-circle me-1"></i> Adicionar ao Escopo (Manual)
                                </label>
                                <textarea name="in_scope" class="form-control font-monospace small" rows="5"
                                    placeholder="login.alvo.com&#10;blog.alvo.com"></textarea>
                                <div class="form-text">Domínios digitados aqui serão <strong>escaneados</strong>.<br>
                                    Não usar Wildcards(*).</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-danger">
                                    <i class="fas fa-ban me-1"></i> Out of Scope
                                </label>
                                <textarea name="out_of_scope" class="form-control font-monospace small" rows="5"
                                    placeholder="store.alvo.com&#10;mail.alvo.com"></textarea>
                                <div class="form-text">Estes domínios serão <strong>ignorados</strong> pelo scanner.
                                    <br> Pode usar Wildcards(*).
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary fw-bold px-4">Criar Projeto</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Switch de Descoberta
        document.getElementById('autoDiscoverySwitch').addEventListener('change', function () {
            if (this.checked) {
                document.getElementById('discoveryTextOn').classList.remove('d-none');
                document.getElementById('discoveryTextOff').classList.add('d-none');
            } else {
                document.getElementById('discoveryTextOn').classList.add('d-none');
                document.getElementById('discoveryTextOff').classList.remove('d-none');
            }
        });

        // Timer de Scan
        document.addEventListener("DOMContentLoaded", function () {
            function updateCountdown() {
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);

                const diff = tomorrow - now;
                if (diff <= 0) return;

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                const hStr = hours.toString().padStart(2, '0');
                const mStr = minutes.toString().padStart(2, '0');
                const sStr = seconds.toString().padStart(2, '0');

                const timerElement = document.getElementById('scan-timer');
                if (timerElement) {
                    timerElement.textContent = `${hStr}h ${mStr}m ${sStr}s`;
                    if (hours < 1) {
                        timerElement.classList.add('text-danger');
                        timerElement.classList.remove('text-dark');
                    } else {
                        timerElement.classList.remove('text-danger');
                        timerElement.classList.add('text-dark');
                    }
                }
            }
            setInterval(updateCountdown, 1000);
            updateCountdown();
        });
        document.addEventListener("DOMContentLoaded", function() {
        // 1. Tenta recuperar a última aba acessada
        const lastTab = localStorage.getItem('activeDashboardTab');
        
        if (lastTab) {
            // Se existir memória, clica na aba para ativá-la
            const tabButton = document.querySelector(`#${lastTab}`);
            if (tabButton) {
                const tab = new bootstrap.Tab(tabButton);
                tab.show();
            }
        }

        // 2. Adiciona ouvinte para salvar sempre que o usuário trocar de aba
        const tabButtons = document.querySelectorAll('button[data-bs-toggle="tab"]');
        tabButtons.forEach(btn => {
            btn.addEventListener('shown.bs.tab', function (event) {
                // Salva o ID do botão clicado (ex: 'projects-tab')
                localStorage.setItem('activeDashboardTab', event.target.id);
            });
        });
    });
    </script>
    {% endblock %}